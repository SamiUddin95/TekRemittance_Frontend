<div class="">
  <app-page-title title="Security Group" subTitle="Security"></app-page-title>
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-light border-bottom">
          <div class="d-flex justify-content-between align-items-center col-12" style="margin-top: -5px; margin-bottom: -5px;">
            <div class="d-flex align-items-center">
              <ng-icon name="tablerShield" class="me-2 gradient-icon" size="20"></ng-icon>
              <h4 class="card-title mb-0 text-dark">Security Group Details</h4>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-dark" (click)="cancel()">
                <ng-icon name="tablerArrowLeft" class="me-1" size="16"></ng-icon>
                Cancel
              </button>
              <button type="button" class="btn submit-button" (click)="submit()">
                <ng-icon name="tablerDeviceFloppy" class="me-1" size="16"></ng-icon>
                Save Group
              </button>
            </div>
          </div>
        </div>

        <div class="card-body">
          <!-- <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" class="nav-tabs mb-3"> -->
           <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" (navChange)="beforeTabChange($event)" class="nav-tabs mb-3">
            <li [ngbNavItem]="'info'">
              <button ngbNavLink>Info</button>
              <ng-template ngbNavContent>
                <form [formGroup]="Groupform" class="mt-3">
                  <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">Security Group Name<span class="text-danger">*</span></label>
                    <div class="col-sm-9">
                      <input type="text" class="form-control" formControlName="name" placeholder="Enter group name" [class.is-invalid]="getFieldError('name')" />
                       <div *ngIf="getFieldError('name')" class="invalid-feedback">
                        {{ getFieldError('name') }}
                    </div>
                    </div>
                  </div>
                  <div class="row mb-3">
                    <label class="col-sm-3 col-form-label">Description<span class="text-danger">*</span></label>
                    <div class="col-sm-9">
                      <textarea rows="3" class="form-control" formControlName="description" placeholder="Enter description"  [class.is-invalid]="getFieldError('description')"></textarea>
                        <div *ngIf="getFieldError('description')" class="invalid-feedback">
                        {{ getFieldError('description') }}
                    </div>
                    </div>
                  </div>
                  <div class="row mb-3">
                        <label class="col-sm-3 col-form-label">Is Active</label>
                        <div class="col-sm-9">
                        <div class="form-check form-switch">
                            <input
                            class="form-check-input"
                            type="checkbox"
                            id="isActive"
                            formControlName="isActive">
                        </div>
                        </div>
                    </div>

                </form>
              </ng-template>
            </li>

            <li ngbNavItem="users">
            <button ngbNavLink  [class.disabled]="isUsersTabDisabled">Users</button>
              <ng-template ngbNavContent>
                <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                  <h6 class="mb-0">Assigned Users</h6>
                  <button class="btn btn-outline-primary btn-sm" (click)="openUserDialog()">
                    <ng-icon name="tablerUserPlus" class="me-1"></ng-icon>
                    Add User
                  </button>
                </div>

                <div class="table-responsive">
                  <table class="table table-bordered table-striped table-sm">
                    <thead class="table text-center">
                      <tr>
                        <th class="fw-bold">Name</th>
                        <th class="fw-bold">Email</th>
                      </tr>
                    </thead>
                    <tbody class="table-group-divider text-center">
                      <tr *ngFor="let u of selectedUsers">
                        <td class="text-break">{{ u.name }}</td>
                        <td class="text-break">{{ u.email }}</td>
                      </tr>
                      <tr *ngIf="selectedUsers.length === 0">
                        <td colspan="2" class="text-center py-3">
                          <div class="text-muted">
                            <ng-icon name="tablerInbox" size="32" class="mb-2 d-block mx-auto"></ng-icon>
                            <p class="mb-0">No users assigned</p>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="modal-backdrop fade show" *ngIf="showUserDialog"></div>
                <div class="modal fade show d-block" tabindex="-1" *ngIf="showUserDialog">
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Select Users</h5>
                        <button type="button" class="btn-close" (click)="closeUserDialog()"></button>
                      </div>
                      <div class="modal-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div>
                            <button class="btn btn-link p-0 me-3" (click)="toggleSelectAllUsers()">
                              {{ selectAllUsers ? 'Unselect All' : 'Select All' }}
                            </button>
                            <form [formGroup]="Groupform">
                            <input
                                type="text"
                                class="form-control form-control-sm"
                                placeholder="Search users..."
                                formControlName="userSearchText"
                                (input)="filterUsers()"
                            />
                            </form>

                          </div>
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                          <table class="table table-bordered table-striped table-sm align-middle mb-0">
                            <thead class="table text-center">
                              <tr>
                                <th style="width: 40px">
                                  <input type="checkbox" class="form-check-input" [checked]="selectAllUsers" (change)="toggleSelectAllUsers()" />
                                </th>
                                <th class="fw-bold">Name</th>
                                <th class="fw-bold">Email</th>
                              </tr>
                            </thead>
                            <tbody class="table-group-divider text-center">
                              <tr *ngFor="let u of filteredUsers">
                                <td>
                                  <input type="checkbox" class="form-check-input"
                                         [checked]="u.id && userSelections[u.id]"
                                         (change)="toggleUserSelection(u)" />
                                </td>
                                <td class="text-break">{{ u.name }}</td>
                                <td class="text-break">{{ u.email }}</td>
                              </tr>
                              <tr *ngIf="filteredUsers.length === 0">
                                <td colspan="3" class="text-center py-3">
                                  <div class="text-muted">
                                    <ng-icon name="tablerInbox" size="32" class="mb-2 d-block mx-auto"></ng-icon>
                                    <p class="mb-0">No users found</p>
                                  </div>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-light" (click)="closeUserDialog()">Cancel</button>
                        <button type="button" class="btn btn-primary" (click)="saveSelectedUsers()">Save</button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>

            <li ngbNavItem="permissions">
  <button ngbNavLink   [class.disabled]="isPermissionsTabDisabled">Security Group Permission</button>
              <ng-template ngbNavContent>
                <div class="mt-3">
                  <div class="card shadow border-0">
                    <!-- <div class="card-header bg-light border-bottom py-2">
                      <div class="d-flex ">
                        <div class="d-flex align-items-center">
                          <div class="rounded-circle d-flex me-2">
                            <ng-icon name="tablerShield" size="16" class="text-primary"></ng-icon>
                          </div>
                          <div>
                            <h6 class="mb-0 text-dark">Modules &amp; Permissions</h6>
                            <small class="text-muted">Manage access per module and component</small>
                          </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <button type="button" class="btn btn-outline-success btn-sm" (click)="selectAllModulePermissions()">
                            Select All
                          </button>
                          <button type="button" class="btn btn-outline-secondary btn-sm" (click)="clearAllModulePermissions()">
                            Clear
                          </button>
                        </div>
                      </div>
                    </div> -->
                    <div class="card-body p-0 bg-white">
                      <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                        <table class="table table-sm mb-0 align-middle">
                          <thead class="table-light text-center" style="position: sticky; top: 0; z-index: 1;">
                            <tr>
                              <th class="text-start ps-4" style="min-width: 260px;">Module / Component</th>
                              <th style="width: 100px;">
                                <div class="d-flex flex-column align-items-center">
                                  <ng-icon name="tablerEye" size="16" class="mb-1 text-secondary"></ng-icon>
                                  <span class="small">View</span>
                                </div>
                              </th>
                              <th style="width: 100px;">
                                <div class="d-flex flex-column align-items-center">
                                  <ng-icon name="tablerSquarePlus" size="16" class="mb-1 text-secondary"></ng-icon>
                                  <span class="small">Create</span>
                                </div>
                              </th>
                              <th style="width: 100px;">
                                <div class="d-flex flex-column align-items-center">
                                  <ng-icon name="tablerEdit" size="16" class="mb-1 text-secondary"></ng-icon>
                                  <span class="small">Edit</span>
                                </div>
                              </th>
                              <th style="width: 100px;">
                                <div class="d-flex flex-column align-items-center">
                                  <ng-icon name="tablerTrash" size="16" class="mb-1 text-secondary"></ng-icon>
                                  <span class="small">Delete</span>
                                </div>
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let row of modulePermissions" [ngClass]="{'table-active fw-semibold': !row.componentLabel}">
                              <td class="text-start ps-4">
                                <div class="d-flex align-items-center">
                                  <div *ngIf="!row.componentLabel" class="form-check me-2">
                                    <input type="checkbox" class="form-check-input" [checked]="row.canView && row.canCreate && row.canEdit && row.canDelete" (change)="toggleModuleRowAll(row)" />
                                  </div>
                                  <span *ngIf="!row.componentLabel" class="text-dark">{{ row.moduleLabel }}</span>
                                  <span *ngIf="row.componentLabel" class="ps-4 small text-muted">{{ row.componentLabel }}</span>
                                </div>
                              </td>
                              <td class="text-center">
                                <div class="form-check d-inline-flex justify-content-center">
                                  <input type="checkbox" class="form-check-input" [checked]="row.canView" (change)="toggleModulePermission(row, 'view')" />
                                </div>
                              </td>
                              <td class="text-center">
                                <div class="form-check d-inline-flex justify-content-center">
                                  <input type="checkbox" class="form-check-input" [checked]="row.canCreate" (change)="toggleModulePermission(row, 'create')" />
                                </div>
                              </td>
                              <td class="text-center">
                                <div class="form-check d-inline-flex justify-content-center">
                                  <input type="checkbox" class="form-check-input" [checked]="row.canEdit" (change)="toggleModulePermission(row, 'edit')" />
                                </div>
                              </td>
                              <td class="text-center">
                                <div class="form-check d-inline-flex justify-content-center">
                                  <input type="checkbox" class="form-check-input" [checked]="row.canDelete" (change)="toggleModulePermission(row, 'delete')" />
                                </div>
                              </td>
                            </tr>
                            <tr *ngIf="modulePermissions.length === 0">
                              <td colspan="5" class="text-center py-3">
                                <div class="text-muted">
                                  <ng-icon name="tablerInbox" size="32" class="mb-2 d-block mx-auto"></ng-icon>
                                  <p class="mb-0">No modules found</p>
                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>
          </ul>

          <div [ngbNavOutlet]="nav"></div>
        </div>
      </div>
    </div>
  </div>
</div>
